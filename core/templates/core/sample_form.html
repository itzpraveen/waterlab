{% extends 'core/base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit Sample{% else %}Add Sample{% endif %} - Water Lab LIMS{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css">
{% endblock %}

{% block page_header %}
<div class="page-header">
    <div class="page-heading">
        <h1 class="page-title">{% if form.instance.pk %}Edit sample{% else %}Register new sample{% endif %}</h1>
        <p class="page-subtitle">Capture collection details and assign the tests required for analysis.</p>
    </div>
    <a href="{% url 'core:sample_list' %}" class="btn btn-outline-secondary"><i class="material-icons me-1">arrow_back</i>Back to list</a>
</div>
{% endblock %}

{% block content %}
<form method="post" novalidate class="form-shell">
    {% csrf_token %}

    {% if form.non_field_errors %}
    <div class="alert alert-danger" role="alert">
        {% for error in form.non_field_errors %}
            <div>{{ error }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="info-card">
        <div class="form-section-title"><i class="material-icons">science</i>Sample details</div>
        <div class="row g-3">
            <div class="col-md-6">
                <label for="{{ form.customer.id_for_label }}" class="form-label">Customer *</label>
                {{ form.customer }}
                {% if form.customer.errors %}<div class="invalid-feedback d-block small">{{ form.customer.errors.0 }}</div>{% endif %}
            </div>
            <div class="col-md-6">
                <label for="{{ form.collection_datetime.id_for_label }}" class="form-label">Collection date &amp; time *</label>
                {{ form.collection_datetime }}
                {% if form.collection_datetime.errors %}
                    <div class="invalid-feedback d-block small">{{ form.collection_datetime.errors.0 }}</div>
                {% else %}
                    <div class="form-text">Format: DD/MM/YYYY HH:MM</div>
                {% endif %}
            </div>
            <div class="col-md-6">
                <label for="{{ form.sample_source.id_for_label }}" class="form-label">Sample source *</label>
                {{ form.sample_source }}
                {% if form.sample_source.errors %}<div class="invalid-feedback d-block small">{{ form.sample_source.errors.0 }}</div>{% endif %}
            </div>
            <div class="col-md-6">
                <label for="{{ form.collected_by.id_for_label }}" class="form-label">Collected by *</label>
                {{ form.collected_by }}
                {% if form.collected_by.errors %}<div class="invalid-feedback d-block small">{{ form.collected_by.errors.0 }}</div>{% endif %}
            </div>
            <div class="col-md-6">
                <label for="{{ form.referred_by.id_for_label }}" class="form-label">Referred by</label>
                {{ form.referred_by }}
                {% if form.referred_by.errors %}<div class="invalid-feedback d-block small">{{ form.referred_by.errors.0 }}</div>{% endif %}
            </div>
        </div>
    </div>

    <div class="info-card">
        <div class="form-section-title"><i class="material-icons">fact_check</i>Tests requested</div>
        {% if form.tests_requested.help_text %}
        <div class="alert alert-info" role="alert">{{ form.tests_requested.help_text }}</div>
        {% endif %}
        <div class="checkbox-grid">
            {% for group, parameters in form.grouped_parameters.items %}
            <div class="checkbox-card">
                <div class="group-title">
                    <input type="checkbox" class="form-check-input parent-checkbox" data-group="{{ group.name|slugify }}" id="group-{{ forloop.counter }}">
                    <label class="form-check-label fw-semibold" for="group-{{ forloop.counter }}">{{ group.name }}</label>
                </div>
                <div class="checkbox-list">
                    {% for parameter in parameters %}
                    <div class="form-check">
                        <input class="form-check-input child-checkbox" type="checkbox" name="{{ form.tests_requested.name }}" value="{{ parameter.pk }}" data-group="{{ group.name|slugify }}" id="param-{{ parameter.pk }}" {% if parameter.pk in form.tests_requested.value %}checked{% endif %}>
                        <label class="form-check-label" for="param-{{ parameter.pk }}">{{ parameter.name }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% if form.tests_requested.errors %}
        <div class="invalid-feedback d-block small">{{ form.tests_requested.errors.0 }}</div>
        {% endif %}
    </div>

    <div class="form-actions">
        <a href="{% url 'core:sample_list' %}" class="btn btn-outline-secondary">Cancel</a>
        <button type="submit" class="btn btn-primary">
            <i class="material-icons me-1">save</i>
            {% if form.instance.pk %}Update sample{% else %}Save sample{% endif %}
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<script>
(function() {
    const parentBoxes = document.querySelectorAll('.parent-checkbox');
    const childBoxes = document.querySelectorAll('.child-checkbox');

    parentBoxes.forEach(parent => {
        parent.addEventListener('change', function() {
            const group = this.dataset.group;
            document.querySelectorAll(`.child-checkbox[data-group="${group}"]`).forEach(child => {
                child.checked = parent.checked;
            });
        });
    });

    const syncParent = (group) => {
        const children = Array.from(document.querySelectorAll(`.child-checkbox[data-group="${group}"]`));
        const parent = document.querySelector(`.parent-checkbox[data-group="${group}"]`);
        if (!parent || children.length === 0) return;
        const checkedCount = children.filter(cb => cb.checked).length;
        parent.indeterminate = checkedCount > 0 && checkedCount < children.length;
        parent.checked = checkedCount === children.length;
    };

    childBoxes.forEach(child => {
        syncParent(child.dataset.group);
        child.addEventListener('change', () => syncParent(child.dataset.group));
    });
})();

document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.querySelector('.js-datetime-picker');
    if (dateInput && window.flatpickr) {
        flatpickr(dateInput, {
            enableTime: true,
            time_24hr: true,
            allowInput: true,
            minuteIncrement: 1,
            altInput: true,
            altInputClass: 'form-control',
            altFormat: dateInput.dataset.altFormat || 'j M Y, h:i K',
            dateFormat: dateInput.dataset.dateFormat || 'd/m/Y H:i',
            defaultDate: dateInput.value || null
        });
    }

    const enhanceSelect = (select) => {
        if (!window.TomSelect || select.tomselect) {
            return;
        }

        const placeholder = select.dataset.placeholder || 'Search options...';
        new TomSelect(select, {
            create: false,
            maxItems: 1,
            allowEmptyOption: true,
            sortField: {
                field: 'text',
                direction: 'asc'
            },
            searchField: ['text'],
            placeholder: placeholder,
            plugins: ['dropdown_input'],
            render: {
                no_results: (data, escape) => '<div class="no-results">No matches found for "' + escape(data.input) + '"</div>'
            }
        });
    };

    document.querySelectorAll('.js-searchable-select').forEach(enhanceSelect);
});
</script>
{% endblock %}
