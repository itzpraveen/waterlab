{% extends 'core/base.html' %}
{% load static %}

{% block title %}Test Result Entry - {{ sample.sample_id }}{% endblock %}

{% block page_header %}
<div class="page-header">
    <div class="page-heading">
        <span class="page-eyebrow">Result entry</span>
        <h1 class="page-title">Test Result Entry</h1>
        <p class="page-subtitle">Capture results for {{ sample.display_id|default:sample.sample_id }}.</p>
    </div>
    <div class="page-actions">
        <a href="{% url 'core:sample_detail' pk=sample.sample_id %}" class="btn btn-outline-secondary">
            <i class="material-icons align-middle me-1">arrow_back</i>
            Back to sample
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<form method="post" class="result-entry-shell">
    {% csrf_token %}

    <section class="info-card result-summary">
        <div class="section-title d-flex align-items-center justify-content-between">
            <span><i class="material-icons">science</i> Sample overview</span>
            <span class="badge-soft info">{{ sample.get_current_status_display }}</span>
        </div>
        <div class="result-summary-grid">
            <div class="summary-item">
                <span class="summary-label">Sample ID</span>
                <span class="summary-value">{{ sample.display_id|default:sample.sample_id }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Customer</span>
                <span class="summary-value"><a href="{% url 'core:customer_detail' pk=sample.customer.customer_id %}" class="link-muted">{{ sample.customer.name }}</a></span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Source</span>
                <span class="summary-value">{{ sample.get_sample_source_display }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Collection Date</span>
                <span class="summary-value">{{ sample.collection_datetime|date:"M d, Y H:i" }}</span>
            </div>
        </div>
    </section>

    {% if form.non_field_errors %}
    <div class="alert alert-danger" role="alert">
        {% for error in form.non_field_errors %}
            <div>{{ error }}</div>
        {% endfor %}
    </div>
    {% endif %}

    {% if sample.tests_requested.count == 0 %}
    <section class="info-card alert-card warning">
        <div class="alert-icon"><i class="material-icons" aria-hidden="true">warning</i></div>
        <div>
            <h2>No test parameters found</h2>
            <p>Add test parameters to this sample before entering results.</p>
            <a href="{% url 'core:sample_edit' pk=sample.sample_id %}" class="btn btn-primary btn-sm"><i class="material-icons align-middle me-1">edit</i>Edit sample</a>
        </div>
    </section>
    {% endif %}

    {% for item in form_data.values %}
    {% with param=item.parameter form=item.form existing=item.existing_result %}
    <section class="info-card result-parameter-card">
        <header class="result-parameter-header">
            <div>
                <h2>{{ param.name }}</h2>
                <p class="text-muted small mb-0">
                    Unit: {{ param.unit|default:"--" }}
                    {% if param.method %} · Method: {{ param.method }}{% endif %}
                    {% if param.min_permissible_limit is not None or param.max_permissible_limit is not None %}
                        · Acceptable:
                        {% if param.min_permissible_limit is not None %}{{ param.min_permissible_limit }}{% else %}–∞{% endif %}
                        –
                        {% if param.max_permissible_limit is not None %}{{ param.max_permissible_limit }}{% else %}+∞{% endif %}
                        {{ param.unit|default:"" }}
                    {% endif %}
                </p>
            </div>
            {% if existing %}
            <div class="result-existing">Last saved: {{ existing.result_value }} {{ param.unit }}</div>
            {% endif %}
        </header>

        <div class="result-parameter-fields">
            {% with field=form.result_value %}
            <div class="form-field">
                <label for="{{ field.id_for_label }}">Result value<span class="required">*</span></label>
                {{ field }}
                {% if field.errors %}
                <p class="form-error">{{ field.errors.0 }}</p>
                {% endif %}
                <small id="status-{{ field.id_for_label }}" class="form-hint" data-unit="{{ param.unit|default:"" }}">
                    {% if param.unit %}Unit: {{ param.unit }}{% endif %}
                </small>
            </div>
            {% endwith %}

            {% with field=form.observation %}
            <div class="form-field">
                <label for="{{ field.id_for_label }}">Observations / Notes</label>
                {{ field }}
                {% if field.errors %}
                <p class="form-error">{{ field.errors.0 }}</p>
                {% endif %}
            </div>
            {% endwith %}

            {% with field=form.remarks %}
            <div class="form-field">
                <label for="{{ field.id_for_label }}">Automated remarks</label>
                {{ field }}
                {% if field.errors %}
                <p class="form-error">{{ field.errors.0 }}</p>
                {% endif %}
            </div>
            {% endwith %}
        </div>
    </section>
    {% endwith %}
    {% endfor %}

    {% if sample.tests_requested.count > 0 %}
    <div class="form-actions">
        <a href="{% url 'core:sample_detail' pk=sample.sample_id %}" class="btn btn-light">Cancel</a>
        <button type="submit" class="btn btn-primary">
            <i class="material-icons align-middle me-1">save</i>
            Save test results
        </button>
    </div>
    {% endif %}
</form>

<section class="info-card result-guidelines">
    <div class="section-title"><i class="material-icons">help_outline</i>Entry guidelines</div>
    <ul class="guideline-list">
        <li>Use numeric values for quantitative tests. Provide the correct unit if it differs from the default.</li>
        <li>For qualitative tests, record standard terms such as “Present”, “Absent”, “Positive”, or “Negative”.</li>
        <li>Observations help consultants understand anomalies—add brief context when limits are exceeded.</li>
        <li>All requested parameters must have a result before the sample can progress.</li>
        <li>Review entries before saving; updates immediately appear in the audit trail.</li>
    </ul>
</section>
{% endblock %}

{% block extra_js %}
<script>
(() => {
  const autoResize = (textarea) => {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
  };

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('textarea.form-control').forEach(textarea => {
      autoResize(textarea);
      textarea.addEventListener('input', () => autoResize(textarea));
    });

    document.querySelectorAll('.result-input').forEach(input => {
      const minLimit = input.dataset.minLimit !== 'None' ? parseFloat(input.dataset.minLimit) : null;
      const maxLimit = input.dataset.maxLimit !== 'None' ? parseFloat(input.dataset.maxLimit) : null;
      const statusEl = document.getElementById('status-' + input.id);
      const remarksInput = document.getElementById(input.id.replace('result_value', 'remarks'));

      const updateStatus = () => {
        const value = parseFloat(input.value);
        if (isNaN(value)) {
          statusEl.textContent = statusEl.dataset.unit ? `Unit: ${statusEl.dataset.unit}` : '';
          statusEl.className = 'form-hint';
          if (remarksInput) remarksInput.value = '';
          return;
        }

        let statusText = 'Within limits';
        let statusClass = 'form-hint success';
        let remarksText = 'Complies with reference limits';

        if (minLimit !== null && value < minLimit) {
          statusText = `Below minimum (${minLimit})`;
          statusClass = 'form-hint warning';
          remarksText = `Below acceptable minimum of ${minLimit}`;
        }
        if (maxLimit !== null && value > maxLimit) {
          statusText = `Above maximum (${maxLimit})`;
          statusClass = 'form-hint danger';
          remarksText = `Exceeds acceptable maximum of ${maxLimit}`;
        }

        statusEl.textContent = statusEl.dataset.unit ? `${statusText} · Unit: ${statusEl.dataset.unit}` : statusText;
        statusEl.className = statusClass;
        if (remarksInput) remarksInput.value = remarksText;
      };

      input.addEventListener('input', updateStatus);
      updateStatus();
    });
  });
})();
</script>
{% endblock extra_js %}
