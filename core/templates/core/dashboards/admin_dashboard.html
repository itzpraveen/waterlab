{% extends 'core/base.html' %}
{% load static %}

{% block title %}Admin Dashboard - Water Lab LIMS{% endblock %}

{% block breadcrumbs %}
<div class="col s12 breadcrumb-container">
    <nav>
        <div class="nav-wrapper">
            <a href="{% url 'core:home' %}" class="breadcrumb">Home</a>
            <span class="breadcrumb active">Admin Dashboard</span>
        </div>
    </nav>
</div>
{% endblock breadcrumbs %}

{% block content %}
<div class="row section">
    <div class="col s12 m8">
        <h4 class="header">üë®‚Äçüíº Administrator Dashboard</h4>
    </div>
    <div class="col s12 m4 right-align">
        <p>
            <span class="role-badge {{ user.role }}">{{ user.get_role_display }}</span>
            Welcome, {{ user.first_name|default:user.username }}!
        </p>
    </div>
</div>

<!-- System Overview Stats -->
<div class="row section">
    <div class="col s12 m6 l3">
        <a href="{% url 'core:customer_list' %}" class="black-text">
            <div class="card-panel hoverable center-align">
                <i class="material-icons large blue-text text-darken-2">people</i>
                <h5>{{ total_customers }}</h5>
                <p class="grey-text">Total Customers</p>
            </div>
        </a>
    </div>
    <div class="col s12 m6 l3">
        <a href="{% url 'core:sample_list' %}" class="black-text">
            <div class="card-panel hoverable center-align">
                <i class="material-icons large teal-text text-darken-2">science</i>
                <h5>{{ total_samples }}</h5>
                <p class="grey-text">Total Samples</p>
            </div>
        </a>
    </div>
    <div class="col s12 m6 l3">
        <a href="{% url 'core:sample_list' %}" class="black-text">
            <div class="card-panel hoverable center-align">
                <i class="material-icons large orange-text text-darken-2">hourglass_empty</i>
                <h5>{{ pending_samples_count }}</h5>
                <p class="grey-text">Pending Samples</p>
            </div>
        </a>
    </div>
    <div class="col s12 m6 l3">
        <a href="{% url 'core:sample_list' %}" class="black-text">
            <div class="card-panel hoverable center-align">
                <i class="material-icons large green-text text-darken-2">check_circle</i>
                <h5>{{ completed_samples_count }}</h5>
                <p class="grey-text">Completed</p>
            </div>
        </a>
    </div>
    <div class="col s12 m6 l3">
        <a href="{% url 'core:sample_list' %}" class="black-text">
            <div class="card-panel hoverable center-align">
                <i class="material-icons large red-text text-darken-2">rate_review</i>
                <h5>{{ review_pending_count }}</h5>
                <p class="grey-text">Review Pending</p>
            </div>
        </a>
    </div>
    <div class="col s12 m6 l3">
        <a href="/admin/auth/user/" class="black-text">
            <div class="card-panel hoverable center-align">
                <i class="material-icons large purple-text text-darken-2">supervisor_account</i>
                <h5>{{ total_users }}</h5>
                <p class="grey-text">System Users</p>
            </div>
        </a>
    </div>
</div>

<!-- Quick Actions -->
<div class="row section">
    <div class="col s12">
        <h5 class="header">‚ö° Quick Actions</h5>
        <a href="{% url 'core:customer_add' %}" class="btn waves-effect waves-light"><i class="material-icons left">person_add</i>Add Customer</a>
        <a href="{% url 'core:sample_add' %}" class="btn waves-effect waves-light"><i class="material-icons left">colorize</i>Register Sample</a>
        <a href="{% url 'core:customer_list' %}" class="btn-flat waves-effect waves-teal"><i class="material-icons left">list_alt</i>View Customers</a>
        <a href="{% url 'core:sample_list' %}" class="btn-flat waves-effect waves-teal"><i class="material-icons left">view_list</i>View Samples</a>
        <a href="{% url 'core:setup_test_parameters' %}" class="btn-flat waves-effect waves-teal"><i class="material-icons left">settings_applications</i>Test Parameters</a>
        <a href="{% url 'core:audit_trail' %}" class="btn-flat waves-effect waves-teal"><i class="material-icons left">history</i>Audit Trail</a>
        <a href="/admin/" class="btn-flat waves-effect waves-teal"><i class="material-icons left">security</i>Admin Panel</a>
    </div>
</div>

<div class="row section">
    <!-- Recent Activity -->
    <div class="col s12 m6">
        <div class="card">
            <div class="card-content">
                <span class="card-title"><i class="material-icons left">timeline</i>Recent Activity</span>
                <h6>Latest Samples</h6>
                {% if recent_samples %}
                <ul class="collection">
                    {% for sample in recent_samples %}
                    <li class="collection-item avatar">
                        <i class="material-icons circle blue">science</i>
                        <span class="title"><a href="{% url 'core:sample_detail' sample.pk %}">Sample {{ sample.sample_id|truncatechars:8 }}</a></span>
                        <p>By: {{ sample.customer.name }} <br>
                           {{ sample.collection_datetime|timesince }} ago
                        </p>
                        <span class="secondary-content chip">{{ sample.get_current_status_display }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="grey-text">No recent samples</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- System Status -->
    <div class="col s12 m6">
        <div class="card">
            <div class="card-content">
                <span class="card-title"><i class="material-icons left">settings_system_daydream</i>System Status</span>
                <ul class="collection">
                    <li class="collection-item">Daily Samples: <span class="right">{{ today_samples_count }}</span></li>
                    <li class="collection-item">Weekly Samples: <span class="right">{{ week_samples_count }}</span></li>
                    <li class="collection-item">Testing in Progress: <span class="right">{{ testing_samples_count }}</span></li>
                </ul>
                <h6 class="mt-3">User Distribution</h6>
                <ul class="collection">
                {% for stat in user_stats %}
                    <li class="collection-item">{{ stat.role|capfirst }}: <span class="right">{{ stat.count }}</span></li>
                {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Recent Users -->
<div class="row section">
    <div class="col s12">
        <div class="card">
            <div class="card-content">
                <span class="card-title"><i class="material-icons left">group</i>Recent Users</span>
                {% if recent_users %}
                <table class="highlight responsive-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Department</th>
                            <th>Joined</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user_obj in recent_users %} {# Renamed user to user_obj to avoid conflict with request.user #}
                        <tr>
                            <td>{{ user_obj.username }}</td>
                            <td>{{ user_obj.first_name }} {{ user_obj.last_name }}</td>
                            <td>
                                <span class="role-badge {{ user_obj.role }}">{{ user_obj.get_role_display }}</span>
                            </td>
                            <td>{{ user_obj.department|default:"‚Äî" }}</td>
                            <td>{{ user_obj.date_joined|date:"M d, Y" }}</td>
                            <td>
                                <span class="new badge {% if user_obj.is_active %}green{% else %}red{% endif %}" data-badge-caption="">
                                    {% if user_obj.is_active %}Active{% else %}Inactive{% endif %}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="grey-text center-align">No users registered yet</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Lab Workflow Overview -->
<div class="row section">
    <div class="col s12">
        <h5 class="header"><i class="material-icons left">device_hub</i>Lab Workflow Overview</h5>
    </div>
    {% if data_load_error %}
    <div class="col s12">
        <div class="card-panel red lighten-2 white-text">
            <span class="card-title">Data Loading Error!</span>
            <p>There was an issue loading some of the dashboard data. Some information might be missing or incomplete. Please try refreshing the page or contact support if the problem persists.</p>
        </div>
    </div>
    {% endif %}
    <div class="col s12 m6">
        <div class="card">
            <div class="card-content">
                <span class="card-title"><i class="material-icons left">local_lab</i>Samples Currently in Lab ({{ samples_in_lab.count }})</span>
                {% if samples_in_lab %}
                <ul class="collection">
                    {% for sample in samples_in_lab %}
                    <li class="collection-item avatar">
                        <i class="material-icons circle amber">opacity</i>
                        <span class="title"><a href="{% url 'core:sample_detail' sample.pk %}">Sample {{ sample.sample_id|truncatechars:8 }}</a></span>
                        <p>{{ sample.customer.name }} <br>
                           {{ sample.get_current_status_display }}
                        </p>
                        <span class="secondary-content chip">{{ sample.collection_datetime|timesince }} ago</span>
                    </li>
                    {% endfor %}
                </ul>
                {% if samples_in_lab.count >= 5 %}
                <div class="card-action right-align">
                    <a href="{% url 'core:sample_list' %}?status=SENT_TO_LAB&status=TESTING_IN_PROGRESS">View all...</a>
                </div>
                {% endif %}
                {% else %}
                <p class="grey-text">No samples currently in the lab.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col s12 m6">
        <div class="card">
            <div class="card-content">
                <span class="card-title"><i class="material-icons left">playlist_add_check</i>Samples Awaiting Review ({{ samples_awaiting_review.count }})</span>
                {% if samples_awaiting_review %}
                <ul class="collection">
                    {% for sample in samples_awaiting_review %}
                    <li class="collection-item avatar">
                        <i class="material-icons circle light-blue">assignment_turned_in</i>
                        <span class="title"><a href="{% url 'core:sample_detail' sample.pk %}">Sample {{ sample.sample_id|truncatechars:8 }}</a></span>
                        <p>{{ sample.customer.name }} <br>
                           Results Entered
                        </p>
                        <span class="secondary-content chip">{{ sample.collection_datetime|timesince }} ago</span>
                    </li>
                    {% endfor %}
                </ul>
                {% if samples_awaiting_review.count >= 5 %}
                <div class="card-action right-align">
                    <a href="{% url 'core:sample_list' %}?status=RESULTS_ENTERED">View all...</a>
                </div>
                {% endif %}
                {% else %}
                <p class="grey-text">No samples currently awaiting review.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .section {
        margin-bottom: 2rem;
    }
    .header { /* For h4, h5 used as section titles */
        font-weight: 400; /* Adjusted for M3 feel */
        margin-top: 1rem;
        margin-bottom: 1.5rem;
        color: var(--text-color-dark);
    }
    .card-panel.hoverable { /* Ensure card panels in stats section use surface color */
        background-color: var(--surface-color);
    }
    .card-panel h5 {
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 1.8rem;
        font-weight: 500; /* Slightly bolder for stat numbers */
        color: var(--text-color-dark);
    }
    .card-panel p {
        font-size: 0.9rem;
        color: var(--text-color-medium);
    }
    .mt-3 { /* For User Distribution title */
        margin-top: 1.5rem !important;
    }
    /* Button margins are handled by Materialize grid or custom spacing if needed */
    /* .btn, .btn-flat {
        margin-right: 5px;
        margin-bottom: 5px; 
    } */
    .collection .collection-item.avatar .secondary-content.chip {
        top: 25px; /* Adjust chip position in avatar collection items */
        font-weight: 500;
    }
    .collection .collection-header {
        background-color: var(--primary-color-light);
        color: var(--primary-color-dark);
        font-weight: 500;
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
    }
    .collection .collection-item {
        border-bottom-color: var(--primary-color-light);
    }
    .collection a.collection-item { /* Ensure links in collections are styled correctly */
        color: var(--text-color-dark);
    }
    .collection a.collection-item:hover {
        background-color: var(--primary-color-light);
        color: var(--primary-color-dark);
    }
    .card .card-action a:not(.btn):not(.btn-large):not(.btn-small):not(.btn-large):not(.btn-floating) {
        color: var(--primary-color) !important; /* Ensure card action links use primary color */
    }
    .card .card-action a:not(.btn):not(.btn-large):not(.btn-small):not(.btn-large):not(.btn-floating):hover {
        color: var(--primary-color-dark) !important;
    }

</style>
{% endblock %}

{% block fab %}
{% if user.is_authenticated and user.is_admin %}
<div class="fixed-action-btn">
    <a class="btn-floating btn-large tooltipped" data-position="left" data-tooltip="Quick Actions" style="background-color: var(--primary-color);">
        <i class="large material-icons">add</i>
    </a>
    <ul>
        <li><a href="{% url 'core:sample_add' %}" class="btn-floating tooltipped" data-position="left" data-tooltip="Register New Sample" style="background-color: var(--info-color);"><i class="material-icons">colorize</i></a></li>
        <li><a href="{% url 'core:customer_add' %}" class="btn-floating tooltipped" data-position="left" data-tooltip="Add New Customer" style="background-color: var(--success-color);"><i class="material-icons">person_add</i></a></li>
    </ul>
</div>
{% endif %}
{% endblock fab %}
