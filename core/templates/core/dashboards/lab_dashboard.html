{% extends 'core/base.html' %}

{% block title %}Lab Dashboard - Water Lab LIMS{% endblock %}

{% block page_header %}
<div class="page-header">
    <div class="page-heading">
        <h1 class="page-title">Laboratory dashboard</h1>
        <p class="page-subtitle">Stay on top of testing queues, recent results, and samples you've closed out.</p>
    </div>
    <div class="badge-soft warning">
        <i class="material-icons">science</i>
        {{ user.get_role_display }}
    </div>
</div>
{% endblock %}

{% block content %}
<section class="stat-grid mb-4">
    <a class="stat-card stat-card--link" href="{% url 'core:sample_list' %}?status=SENT_TO_LAB&status=TESTING_IN_PROGRESS">
        <div class="stat-icon"><i class="material-icons">hourglass_empty</i></div>
        <div class="stat-value">{{ pending_tests }}</div>
        <p class="stat-label mb-0">Pending tests</p>
    </a>
    <a class="stat-card stat-card--link" href="{% url 'core:sample_list' %}?status=RESULTS_ENTERED">
        <div class="stat-icon"><i class="material-icons">fact_check</i></div>
        <div class="stat-value">{{ completed_tests }}</div>
        <p class="stat-label mb-0">Results entered</p>
    </a>
    <a class="stat-card stat-card--link" href="/admin/core/testresult/?entered_by__id__exact={{ user.id }}">
        <div class="stat-icon"><i class="material-icons">assignment_turned_in</i></div>
        <div class="stat-value">{{ my_tests }}</div>
        <p class="stat-label mb-0">My total tests</p>
    </a>
    <a class="stat-card stat-card--link" href="/admin/core/testresult/?test_date__day={% now 'd' %}&test_date__month={% now 'm' %}&test_date__year={% now 'Y' %}">
        <div class="stat-icon"><i class="material-icons">today</i></div>
        <div class="stat-value">{{ today_tests }}</div>
        <p class="stat-label mb-0">Today's tests</p>
    </a>
    <a class="stat-card stat-card--link" href="{% url 'core:setup_test_parameters' %}">
        <div class="stat-icon"><i class="material-icons">tune</i></div>
        <div class="stat-value">{{ total_parameters }}</div>
        <p class="stat-label mb-0">Test parameters</p>
    </a>
</section>

<section class="info-card mb-4">
    <div class="section-title"><i class="material-icons">flash_on</i>Quick actions</div>
    <div class="quick-link-bar">
        <a href="{% url 'core:sample_list' %}?status=SENT_TO_LAB" class="action-chip action-chip--primary">
            <i class="material-icons">colorize</i>
            Enter results
        </a>
        <a href="{% url 'core:sample_list' %}" class="action-chip">
            <i class="material-icons">inventory_2</i>
            View samples
        </a>
        <a href="{% url 'core:test_result_list' %}" class="action-chip">
            <i class="material-icons">list_alt</i>
            My results queue
        </a>
        <a href="{% url 'core:setup_test_parameters' %}" class="action-chip">
            <i class="material-icons">science</i>
            Manage parameters
        </a>
    </div>
</section>

<div class="row g-4">
    <div class="col-12 col-xl-7">
        <div class="info-card h-100">
            <div class="section-title"><i class="material-icons">playlist_add</i>Samples awaiting testing</div>
            {% if samples_for_testing %}
            <div class="list-group list-group-flush">
                {% for sample in samples_for_testing %}
                <div class="list-group-item d-flex flex-column flex-lg-row gap-3 align-items-lg-center justify-content-between">
                    <div>
                        <div class="fw-semibold">{{ sample.sample_id }}</div>
                        <div class="text-muted small">
                            {{ sample.customer.name }} · Collected {{ sample.collection_datetime|date:"M d, Y H:i" }}
                        </div>
                        <div class="text-muted small">
                            {{ sample.get_sample_source_display }}
                        </div>
                    </div>
                    <div class="d-flex flex-column align-items-start align-items-lg-end gap-2">
                        <span class="badge bg-warning-subtle text-warning-emphasis">{{ sample.get_current_status_display }}</span>
                        <div class="btn-group btn-group-sm">
                            <a href="{% url 'core:sample_detail' sample.pk %}" class="btn btn-outline-secondary">Details</a>
                            <a href="{% url 'core:test_result_entry' sample.pk %}" class="btn btn-primary">Enter results</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="material-icons">task_alt</i>
                <p class="mb-0">There are no samples waiting for lab processing.</p>
            </div>
            {% endif %}
        </div>
    </div>
    <div class="col-12 col-xl-5">
        <div class="info-card h-100">
            <div class="section-title"><i class="material-icons">history</i>My recent test results</div>
            {% if recent_results %}
            <div class="list-group list-group-flush">
                {% for result in recent_results %}
                <div class="list-group-item d-flex flex-column gap-2">
                    <div class="d-flex justify-content-between align-items-start gap-3">
                        <div>
                            <div class="fw-semibold">{{ result.parameter.name }}</div>
                            <div class="text-muted small">
                                Sample {{ result.sample.sample_id }} · {{ result.test_date|date:"M d, Y H:i" }}
                            </div>
                        </div>
                        <span class="badge bg-primary-subtle text-primary-emphasis">
                            {{ result.result_value }} {{ result.parameter.unit }}
                        </span>
                    </div>
                    {% if result.parameter.min_permissible_limit and result.parameter.max_permissible_limit %}
                    <div class="small">
                        <span class="text-muted">Permissible:</span>
                        {{ result.parameter.min_permissible_limit }} – {{ result.parameter.max_permissible_limit }} {{ result.parameter.unit }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="material-icons">pending_actions</i>
                <p class="mb-0">Your latest test entries will appear here once submitted.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="row g-4 mt-1">
    <div class="col-12 col-lg-6">
        <div class="info-card h-100">
            <div class="section-title"><i class="material-icons">task_alt</i>My recently completed samples</div>
            {% if recently_completed_samples %}
            <div class="list-group list-group-flush">
                {% for sample in recently_completed_samples %}
                <div class="list-group-item d-flex justify-content-between align-items-start gap-3">
                    <div>
                        <a href="{% url 'core:sample_detail' sample.pk %}" class="fw-semibold text-decoration-none">
                            {{ sample.sample_id }}
                        </a>
                        <div class="text-muted small">
                            {{ sample.customer.name }} · {{ sample.collection_datetime|date:"M d, Y H:i" }}
                        </div>
                    </div>
                    <span class="badge bg-success-subtle text-success-emphasis">{{ sample.get_current_status_display }}</span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted mb-0">Completed samples you participated in will be listed here.</p>
            {% endif %}
        </div>
    </div>
    <div class="col-12 col-lg-6">
        <div class="info-card h-100">
            <div class="section-title"><i class="material-icons">tips_and_updates</i>Testing toolkit</div>
            <p class="text-muted mb-3">Need to revisit limits or update parameters? Jump straight into the configuration screens.</p>
            <div class="d-flex flex-wrap gap-2">
                <a href="{% url 'core:setup_test_parameters' %}" class="btn btn-outline-secondary btn-sm"><i class="material-icons me-1">tune</i>Parameter library</a>
                <a href="{% url 'core:test_result_list' %}" class="btn btn-outline-secondary btn-sm"><i class="material-icons me-1">table_chart</i>Results archive</a>
                <a href="{% url 'core:sample_list' %}?status=RESULTS_ENTERED" class="btn btn-outline-secondary btn-sm"><i class="material-icons me-1">done_all</i>Awaiting review</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
