{% extends 'core/base.html' %}

{% block title %}Audit Trail - WaterLab LIMS{% endblock %}

{% block page_header %}
<div class="page-header">
    <div class="page-heading">
        <span class="page-eyebrow">System activity</span>
        <h1 class="page-title">Audit Trail</h1>
        <p class="page-subtitle">Review every change across samples, customers, and configuration to keep operations compliant.</p>
    </div>
    <div class="page-actions">
        <a href="{% url 'core:admin_dashboard' %}" class="btn btn-outline-secondary">
            <i class="material-icons align-middle me-1">arrow_back</i>Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="audit-shell">
    <section class="info-card">
        <div class="section-title"><i class="material-icons">filter_list</i>Filters</div>
        <form method="get" class="audit-filters">
            <div class="filter-grid">
                <div class="form-field">
                    <label for="model">Model type</label>
                    <select name="model" id="model" class="form-control">
                        <option value="" {% if not filters.model %}selected{% endif %}>All models</option>
                        {% for model_name_opt in model_choices %}
                        <option value="{{ model_name_opt }}" {% if filters.model == model_name_opt %}selected{% endif %}>{{ model_name_opt }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-field">
                    <label for="action">Action</label>
                    <select name="action" id="action" class="form-control">
                        <option value="" {% if not filters.action %}selected{% endif %}>All actions</option>
                        {% for action_opt in action_choices %}
                        <option value="{{ action_opt }}" {% if filters.action == action_opt %}selected{% endif %}>{{ action_opt|capfirst }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-field">
                    <label for="user_filter">User</label>
                    <select name="user" id="user_filter" class="form-control">
                        <option value="" {% if not filters.user %}selected{% endif %}>All users</option>
                        {% for user_opt in users %}
                        <option value="{{ user_opt.pk }}" {% if filters.user == user_opt.pk|stringformat:"s" %}selected{% endif %}>{{ user_opt.first_name|default:user_opt.username }} ({{ user_opt.get_role_display }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-field">
                    <label for="object_id">Object ID</label>
                    <input type="text" name="object_id" id="object_id" class="form-control" value="{{ filters.object_id }}" placeholder="e.g. WL2025-0008">
                </div>
            </div>
            <div class="filter-actions">
                <a href="{% url 'core:audit_trail' %}" class="btn btn-light">Clear filters</a>
                <button type="submit" class="btn btn-primary"><i class="material-icons align-middle me-1">search</i>Apply filters</button>
            </div>
        </form>
    </section>

    <section class="info-card">
        <div class="section-title"><i class="material-icons">history</i>Activity log</div>

        {% if page_obj.object_list %}
        <div class="table-responsive">
            <table class="table table-modern align-middle audit-table">
                <thead>
                    <tr>
                        <th>When</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Model</th>
                        <th>Object</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in page_obj.object_list %}
                    <tr>
                        <td class="text-muted small">
                            <div class="fw-semibold">{{ log.timestamp|date:"d M Y, H:i" }}</div>
                            <div>{{ log.ip_address|default:"N/A" }}</div>
                        </td>
                        <td>
                            <div class="fw-semibold">{{ log.user.first_name|default:log.user.username }}</div>
                            <div class="text-muted small">{{ log.user.get_role_display }}</div>
                        </td>
                        <td><span class="badge-soft {% if log.action == 'CREATE' %}success{% elif log.action == 'DELETE' %}danger{% elif log.action == 'UPDATE' %}info{% endif %}">{{ log.action|title }}</span></td>
                        <td>{{ log.model_name|default:"—" }}</td>
                        <td>
                            {% if log.object_id %}
                                <div class="fw-semibold">{{ log.object_repr|default:"–" }}</div>
                                <div class="text-muted small">ID: {{ log.object_id }}</div>
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td>
                            {% if log.changes %}
                            <button type="button" class="btn btn-light btn-sm change-toggle" data-target="changes-{{ log.pk }}">
                                <i class="material-icons align-middle me-1">unfold_more</i><span class="toggle-label">View changes</span>
                            </button>
                            <div id="changes-{{ log.pk }}" class="change-panel" hidden>
                                <dl>
                                    {% for field, change in log.changes.items %}
                                    <div class="change-row">
                                        <dt>{{ field|capfirst }}</dt>
                                        <dd>{{ change.old|default:"(empty)" }} → {{ change.new|default:"(empty)" }}</dd>
                                    </div>
                                    {% endfor %}
                                </dl>
                            </div>
                            {% else %}
                            <span class="text-muted small">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if is_paginated %}
        <nav class="results-pagination" aria-label="Audit pagination">
            <ul class="pagination pagination-modern justify-content-center">
                <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                    <a class="page-link" href="{% if page_obj.has_previous %}?page={{ page_obj.previous_page_number }}{{ querystring_without_page }}{% else %}#!{% endif %}">&laquo;</a>
                </li>
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% elif num == 1 or num == page_obj.paginator.num_pages or num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
                        <li class="page-item"><a class="page-link" href="?page={{ num }}{{ querystring_without_page }}">{{ num }}</a></li>
                    {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
                        <li class="page-item disabled"><span class="page-link">…</span></li>
                    {% endif %}
                {% endfor %}
                <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{% if page_obj.has_next %}?page={{ page_obj.next_page_number }}{{ querystring_without_page }}{% else %}#!{% endif %}">&raquo;</a>
                </li>
            </ul>
        </nav>
        {% endif %}

        {% else %}
        <div class="alert alert-info" role="status">
            <i class="material-icons align-middle me-2">info_outline</i>No audit logs found for the selected criteria.
        </div>
        {% endif %}
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.change-toggle').forEach(button => {
    button.addEventListener('click', () => {
      const targetId = button.getAttribute('data-target');
      const panel = document.getElementById(targetId);
      if (!panel) return;
      const isHidden = panel.hasAttribute('hidden');
      panel.toggleAttribute('hidden', !isHidden);
      const icon = button.querySelector('.material-icons');
      const label = button.querySelector('.toggle-label');
      if (icon) icon.textContent = isHidden ? 'unfold_less' : 'unfold_more';
      if (label) label.textContent = isHidden ? 'Hide changes' : 'View changes';
      button.classList.toggle('active', isHidden);
    });
  });
});
</script>
{% endblock %}
