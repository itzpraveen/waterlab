{% extends 'core/base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit Customer{% else %}Add Customer{% endif %} - Water Lab LIMS{% endblock %}

{% block page_header %}
<div class="page-header">
    <div class="page-heading">
        <h1 class="page-title">{% if form.instance.pk %}Edit customer{% else %}Add customer{% endif %}</h1>
        <p class="page-subtitle">Create and maintain customer records for faster sample registration and reporting.</p>
    </div>
    <a href="{% url 'core:customer_list' %}" class="btn btn-outline-secondary"><i class="material-icons me-1">arrow_back</i>Back to customers</a>
</div>
{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css">
<form method="post" novalidate class="form-shell">
    {% csrf_token %}

    {% if form.non_field_errors %}
    <div class="alert alert-danger" role="alert">
        {% for error in form.non_field_errors %}
            <div>{{ error }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="info-card">
        <div class="form-section-title"><i class="material-icons">person</i>Customer profile</div>
        <div class="row g-3">
            <div class="col-md-12">
                <label for="{{ form.name.id_for_label }}" class="form-label">Customer name *</label>
                {{ form.name }}
                {% if form.name.errors %}<div class="invalid-feedback d-block small">{{ form.name.errors.0 }}</div>{% endif %}
            </div>
            <div class="col-md-6">
                <label for="{{ form.email.id_for_label }}" class="form-label">Email *</label>
                {{ form.email }}
                {% if form.email.errors %}<div class="invalid-feedback d-block small">{{ form.email.errors.0 }}</div>{% else %}<div class="form-text">e.g., customer@example.com</div>{% endif %}
            </div>
            <div class="col-md-6">
                <label for="{{ form.phone.id_for_label }}" class="form-label">Phone *</label>
                {{ form.phone }}
                {% if form.phone.errors %}<div class="invalid-feedback d-block small">{{ form.phone.errors.0 }}</div>{% else %}<div class="form-text">10-digit Indian mobile number</div>{% endif %}
            </div>
        </div>
    </div>

    <div class="info-card">
        <div class="form-section-title"><i class="material-icons">location_on</i>Address details</div>
        {% if request.user.is_staff %}
        <div class="mb-2 small text-muted">
            Admin shortcut: <a href="/admin/core/keralalocation/" target="_blank">Manage address data (districts / taluks / panchayats)</a>
        </div>
        {% endif %}
        <div class="row g-3">
            <div class="col-md-6">
                <label for="{{ form.house_name_door_no.id_for_label }}" class="form-label">House name / door number</label>
                {{ form.house_name_door_no }}
                {% if form.house_name_door_no.errors %}<div class="invalid-feedback d-block small">{{ form.house_name_door_no.errors.0 }}</div>{% endif %}
            </div>
            <div class="col-md-6">
                <label for="{{ form.street_locality_landmark.id_for_label }}" class="form-label">Street / locality *</label>
                {{ form.street_locality_landmark }}
                {% if form.street_locality_landmark.errors %}<div class="invalid-feedback d-block small">{{ form.street_locality_landmark.errors.0 }}</div>{% endif %}
            </div>
            <div class="col-md-6">
                <label for="{{ form.village_town_city.id_for_label }}" class="form-label">Village / town / city *</label>
                {{ form.village_town_city }}
                {% if form.village_town_city.errors %}<div class="invalid-feedback d-block small">{{ form.village_town_city.errors.0 }}</div>{% endif %}
            </div>
            <div class="col-md-6">
                <label for="{{ form.panchayat_municipality.id_for_label }}" class="form-label">Panchayat / municipality *</label>
                {{ form.panchayat_municipality }}
                {% if form.panchayat_municipality.errors %}<div class="invalid-feedback d-block small">{{ form.panchayat_municipality.errors.0 }}</div>{% endif %}
            </div>
            <div class="col-md-6">
                <label for="{{ form.taluk.id_for_label }}" class="form-label">Taluk *</label>
                {{ form.taluk }}
                {% if form.taluk.errors %}<div class="invalid-feedback d-block small">{{ form.taluk.errors.0 }}</div>{% endif %}
            </div>
            <div class="col-md-6">
                <label for="{{ form.district.id_for_label }}" class="form-label">District *</label>
                {{ form.district }}
                {% if form.district.errors %}<div class="invalid-feedback d-block small">{{ form.district.errors.0 }}</div>{% endif %}
            </div>
            <div class="col-md-6">
                <label for="{{ form.pincode.id_for_label }}" class="form-label">PIN code *</label>
                {{ form.pincode }}
                {% if form.pincode.errors %}<div class="invalid-feedback d-block small">{{ form.pincode.errors.0 }}</div>{% else %}<div class="form-text">Kerala PIN codes start with 6</div>{% endif %}
            </div>
            <div class="col-md-6">
                <label for="{{ form.address.id_for_label }}" class="form-label">Auto-composed address</label>
                {{ form.address }}
                <div class="form-text">Populated automatically from the fields above.</div>
            </div>
        </div>
    </div>

    <div class="form-actions">
        <a href="{% url 'core:customer_list' %}" class="btn btn-outline-secondary">Cancel</a>
        <button type="submit" class="btn btn-primary">
            <i class="material-icons me-1">save</i>
            {% if form.instance.pk %}Update customer{% else %}Save customer{% endif %}
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<script src="{% static 'js/address_helper.js' %}"></script>
<script>
(function() {
    const phoneInput = document.getElementById('{{ form.phone.id_for_label }}');
    if (phoneInput) {
        phoneInput.addEventListener('input', function () {
            this.value = this.value.replace(/\D/g, '').slice(0, 10);
        });
    }

    const pincodeInput = document.getElementById('{{ form.pincode.id_for_label }}');
    if (pincodeInput) {
        pincodeInput.addEventListener('input', function () {
            this.value = this.value.replace(/\D/g, '').slice(0, 6);
            updateAddress();
        });
    }

    function updateAddress() {
        const partIds = [
            '{{ form.house_name_door_no.id_for_label }}',
            '{{ form.street_locality_landmark.id_for_label }}',
            '{{ form.village_town_city.id_for_label }}',
            '{{ form.panchayat_municipality.id_for_label }}',
            '{{ form.taluk.id_for_label }}',
            '{{ form.district.id_for_label }}',
            '{{ form.pincode.id_for_label }}'
        ];
        const parts = [];
        partIds.forEach((id) => {
            const el = document.getElementById(id);
            if (!el) return;
            let value = '';
            if (el.tagName === 'SELECT') {
                const opt = el.options[el.selectedIndex];
                if (opt && opt.value) {
                    value = opt.text.trim();
                }
            } else if (el.value.trim()) {
                value = el.value.trim();
            }
            if (!value) return;
            if (id === '{{ form.taluk.id_for_label }}') value += ' Taluk';
            if (id === '{{ form.district.id_for_label }}') value += ' District';
            if (id === '{{ form.pincode.id_for_label }}') value = 'Kerala - ' + value;
            parts.push(value);
        });
        const addressField = document.getElementById('{{ form.address.id_for_label }}');
        if (addressField) {
            addressField.value = parts.join(', ');
        }
    }

    const addressIds = [
        '{{ form.house_name_door_no.id_for_label }}',
        '{{ form.street_locality_landmark.id_for_label }}',
        '{{ form.village_town_city.id_for_label }}',
        '{{ form.panchayat_municipality.id_for_label }}',
        '{{ form.taluk.id_for_label }}',
        '{{ form.district.id_for_label }}'
    ];

    addressIds.forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        const eventName = el.tagName === 'SELECT' ? 'change' : 'input';
        el.addEventListener(eventName, updateAddress);
    });

    updateAddress();
})();
</script>
{% endblock %}
