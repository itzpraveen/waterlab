{% extends 'core/base.html' %}
{% load static %}

{% block title %}Sample {{ sample.sample_id }} - Water Lab LIMS{% endblock %}

{% block page_header %}
<div class="page-header">
    <div class="page-heading">
        <h1 class="page-title">Sample {{ sample.display_id|default:sample.sample_id }}</h1>
        <p class="page-subtitle">Collected {{ sample.collection_datetime|date:"M d, Y H:i" }} for {{ sample.customer.name }}.</p>
        <div class="d-flex flex-wrap gap-2 mt-2">
            {% with status=sample.current_status %}
                {% if status == 'REPORT_APPROVED' or status == 'REPORT_SENT' %}
                    <span class="badge-soft success"><i class="material-icons">check_circle</i>{{ sample.get_current_status_display }}</span>
                {% elif status == 'RESULTS_ENTERED' or status == 'REVIEW_PENDING' %}
                    <span class="badge-soft warning"><i class="material-icons">hourglass_empty</i>{{ sample.get_current_status_display }}</span>
                {% elif status == 'TESTING_IN_PROGRESS' %}
                    <span class="badge-soft info"><i class="material-icons">science</i>{{ sample.get_current_status_display }}</span>
                {% else %}
                    <span class="badge-soft"><i class="material-icons">assignment</i>{{ sample.get_current_status_display }}</span>
                {% endif %}
            {% endwith %}
            <span class="badge-soft info"><i class="material-icons">opacity</i>{{ sample.get_sample_source_display }}</span>
        </div>
    </div>
    <div class="d-flex flex-column flex-sm-row gap-2">
        <a href="{% url 'core:sample_list' %}" class="btn btn-outline-secondary">
            <i class="material-icons me-1">arrow_back</i>Back to samples
        </a>
        {% if user.is_lab_technician or user.is_admin %}
        <a href="{% url 'core:sample_report_metadata' sample.pk %}" class="btn btn-primary">
            <i class="material-icons me-1">tune</i>Update report metadata
        </a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block content %}
<div class="summary-grid">
    {% with status=sample.current_status %}
    <div class="summary-card">
        <span class="summary-icon material-icons">
            {% if status == 'REPORT_APPROVED' or status == 'REPORT_SENT' %}verified{% elif status == 'RESULTS_ENTERED' or status == 'REVIEW_PENDING' %}hourglass_bottom{% elif status == 'TESTING_IN_PROGRESS' %}science{% else %}flag_circle{% endif %}
        </span>
        <p class="summary-label">Current Status</p>
        <p class="summary-value">{{ sample.get_current_status_display }}</p>
        <span class="summary-meta">
            <i class="material-icons">schedule</i>
            {% if sample.test_completed_on %}
                Tests completed {{ sample.test_completed_on|date:"M d, Y" }}
            {% elif sample.date_received_at_lab %}
                Received {{ sample.date_received_at_lab|date:"M d, Y H:i" }}
            {% else %}
                Collected {{ sample.collection_datetime|date:"M d, Y H:i" }}
            {% endif %}
        </span>
    </div>
    {% endwith %}

    {% with total_tests=sample.tests_requested.count results_count=sample.results.count %}
    <div class="summary-card">
        <span class="summary-icon material-icons">biotech</span>
        <p class="summary-label">Requested Tests</p>
        <p class="summary-value">{{ total_tests }}</p>
        <span class="summary-meta">
            <i class="material-icons">fact_check</i>
            {% if total_tests %}
                {{ results_count }} of {{ total_tests }} completed{% if results_count < total_tests %} · Awaiting results{% else %} · All results recorded{% endif %}
            {% else %}
                No tests assigned
            {% endif %}
        </span>
    </div>
    {% endwith %}

    <div class="summary-card">
        <span class="summary-icon material-icons">water_drop</span>
        <p class="summary-label">Sample Type</p>
        <p class="summary-value">{{ sample.sample_type|default:"Water" }}</p>
        {% with sample.sampling_location|default:sample.customer.village_town_city as location %}
        <span class="summary-meta">
            <i class="material-icons">place</i>
            {{ location|default:"Location not recorded" }}
        </span>
        {% endwith %}
        <span class="summary-meta">
            <i class="material-icons">calendar_month</i>
            {% if sample.test_commenced_on and sample.test_completed_on %}
                Commenced {{ sample.test_commenced_on|date:"M d, Y" }} · Completed {{ sample.test_completed_on|date:"M d, Y" }}
            {% elif sample.test_commenced_on %}
                Commenced {{ sample.test_commenced_on|date:"M d, Y" }}
            {% elif sample.test_completed_on %}
                Completed {{ sample.test_completed_on|date:"M d, Y" }}
            {% else %}
                Testing dates not recorded
            {% endif %}
        </span>
    </div>
</div>

<div class="row g-4">
    <div class="col-12 col-xl-7">
        <div class="info-card mb-4">
            <div class="section-title"><i class="material-icons">info_outline</i>Sample overview</div>
            <dl class="data-pairs">
                <div class="data-pair">
                    <dt>Sample ID</dt>
                    <dd>{{ sample.display_id|default:sample.sample_id }}</dd>
                </div>
                <div class="data-pair">
                    <dt>Customer</dt>
                    <dd><a href="{% url 'core:customer_detail' sample.customer.pk %}">{{ sample.customer.name }}</a></dd>
                </div>
                <div class="data-pair">
                    <dt>Collection Date</dt>
                    <dd>{{ sample.collection_datetime|date:"M d, Y H:i" }}</dd>
                </div>
                <div class="data-pair">
                    <dt>Received at Lab</dt>
                    <dd>{{ sample.date_received_at_lab|date:"M d, Y H:i"|default:"Not yet received" }}</dd>
                </div>
                <div class="data-pair">
                    <dt>Collected By</dt>
                    <dd>{{ sample.get_collected_by_display }}</dd>
                </div>
                {% if sample.referred_by %}
                <div class="data-pair">
                    <dt>Referred By</dt>
                    <dd>{{ sample.referred_by }}</dd>
                </div>
                {% endif %}
                <div class="data-pair">
                    <dt>Report Number</dt>
                    <dd>{{ sample.report_number|default:"Not assigned" }}</dd>
                </div>
                <div class="data-pair">
                    <dt>Invoice Number</dt>
                    <dd>
                        {% if invoice %}
                            {{ invoice.invoice_number|default:"Not assigned" }}
                        {% else %}
                            Not generated
                        {% endif %}
                    </dd>
                </div>
                <div class="data-pair">
                    <dt>Location</dt>
                    {% with sample.sampling_location|default:sample.customer.village_town_city as location %}
                    <dd>{{ location|default:"Not recorded" }}</dd>
                    {% endwith %}
                </div>
                <div class="data-pair">
                    <dt>Test Commenced</dt>
                    <dd>
                        {% if sample.test_commenced_on %}
                            {{ sample.test_commenced_on|date:"M d, Y" }}
                        {% else %}
                            <span class="text-muted">Not recorded</span>
                        {% endif %}
                    </dd>
                </div>
                <div class="data-pair">
                    <dt>Test Completed</dt>
                    <dd>
                        {% if sample.test_completed_on %}
                            {{ sample.test_completed_on|date:"M d, Y" }}
                        {% else %}
                            <span class="text-muted">Not recorded</span>
                        {% endif %}
                    </dd>
                </div>
                <div class="data-pair">
                    <dt>Quantity Received</dt>
                    <dd>{{ sample.quantity_received|default:"Not recorded" }}</dd>
                </div>
                <div class="data-pair">
                    <dt>Sampling Procedure</dt>
                    <dd>{{ sample.sampling_procedure|default:"Not recorded" }}</dd>
                </div>
                <div class="data-pair">
                    <dt>Chief of Quality - Microbiology</dt>
                    {% with signatory=resolved_signatories.bio_manager %}
                    <dd>
                        {% if signatory %}
                            {{ signatory.get_full_name|default:signatory.username }}
                        {% else %}
                            <span class="text-muted">Not assigned</span>
                        {% endif %}
                    </dd>
                    {% endwith %}
                </div>
                <div class="data-pair">
                    <dt>Chief of Quality - Chemistry</dt>
                    {% with signatory=resolved_signatories.chem_manager %}
                    <dd>
                        {% if signatory %}
                            {{ signatory.get_full_name|default:signatory.username }}
                        {% else %}
                            <span class="text-muted">Not assigned</span>
                        {% endif %}
                    </dd>
                    {% endwith %}
                </div>
                <div class="data-pair">
                    <dt>Chief Scientific Officer</dt>
                    {% with signatory=resolved_signatories.food_analyst %}
                    <dd>
                        {% if signatory %}
                            {{ signatory.get_full_name|default:signatory.username }}
                        {% else %}
                            <span class="text-muted">Not assigned</span>
                        {% endif %}
                    </dd>
                    {% endwith %}
                </div>
            </dl>
        </div>

        <div class="info-card mb-4">
            <div class="section-title"><i class="material-icons">checklist</i>Tests requested</div>
            {% if tests_by_category %}
            <div class="table-responsive">
                <table class="table table-modern align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="text-center">Sl No</th>
                            <th>Test</th>
                            <th>Method</th>
                            <th>Unit</th>
                            <th>Permissible range</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for category_name, tests in tests_by_category.items %}
                        <tr>
                            <th colspan="5">{{ category_name|default:"Uncategorized" }}</th>
                        </tr>
                            {% for entry in tests %}
                            <tr>
                                <td class="text-center">{{ entry.index }}</td>
                                <td>{{ entry.item.name }}</td>
                                <td>{{ entry.item.method|default:"--" }}</td>
                                <td>{{ entry.item.unit }}</td>
                                <td>
                                    {% if entry.item.max_limit_display %}
                                        {{ entry.item.max_limit_display }}
                                    {% elif entry.item.min_permissible_limit and entry.item.max_permissible_limit %}
                                        {{ entry.item.min_permissible_limit }} – {{ entry.item.max_permissible_limit }}
                                    {% elif entry.item.max_permissible_limit %}
                                        ≤ {{ entry.item.max_permissible_limit }}
                                    {% elif entry.item.min_permissible_limit %}
                                        ≥ {{ entry.item.min_permissible_limit }}
                                    {% else %}
                                        <span class="text-muted">Not specified</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted mb-0">No additional tests were requested for this sample.</p>
            {% endif %}
        </div>

        {% if results_by_category %}
        <div class="info-card">
            <div class="section-title"><i class="material-icons">assessment</i>Test results</div>
            <div class="table-responsive">
                <table class="table table-modern align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="text-center">Sl No</th>
                            <th>Parameter</th>
                            <th>Method</th>
                            <th class="text-center">Result</th>
                            <th>Unit</th>
                            <th>Limits</th>
                            <th class="text-center">Status</th>
                            <th>Observation</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for category_name, category_results in results_by_category.items %}
                        <tr>
                            <th colspan="8">{{ category_name|default:"Uncategorized" }}</th>
                        </tr>
                            {% for entry in category_results %}
                            <tr class="{% if entry.is_out_of_range %}result-out-of-range{% endif %}">
                                <td class="text-center">{{ entry.index }}</td>
                                <td>{{ entry.item.parameter.name }}</td>
                                <td>{{ entry.item.parameter.method|default:"--" }}</td>
                                <td class="text-center fw-semibold result-value">{{ entry.item.result_value }}</td>
                                <td>{{ entry.item.parameter.unit }}</td>
                                <td>
                                    {% if entry.item.parameter.max_limit_display %}
                                        {{ entry.item.parameter.max_limit_display }}
                                    {% elif entry.item.parameter.min_permissible_limit and entry.item.parameter.max_permissible_limit %}
                                        {{ entry.item.parameter.min_permissible_limit }} – {{ entry.item.parameter.max_permissible_limit }}
                                    {% elif entry.item.parameter.max_permissible_limit %}
                                        ≤ {{ entry.item.parameter.max_permissible_limit }}
                                    {% elif entry.item.parameter.min_permissible_limit %}
                                        ≥ {{ entry.item.parameter.min_permissible_limit }}
                                    {% else %}
                                        <span class="text-muted">Not specified</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if entry.item.parameter.max_limit_display %}
                                        <span class="badge-soft">Qualitative limit</span>
                                    {% elif entry.item.parameter.min_permissible_limit is not None and entry.item.parameter.max_permissible_limit is not None %}
                                        {% if entry.limit_status == 'WITHIN_LIMITS' %}
                                            <span class="badge-soft success">Within limits</span>
                                        {% elif entry.limit_status == 'BELOW_LIMIT' %}
                                            <span class="badge-soft danger">Below minimum</span>
                                        {% elif entry.limit_status == 'ABOVE_LIMIT' %}
                                            <span class="badge-soft danger">Above maximum</span>
                                        {% elif entry.limit_status == 'NON_NUMERIC' %}
                                            <span class="badge-soft warning">Result not numeric</span>
                                        {% elif entry.limit_status == 'UNKNOWN' %}
                                            <span class="badge-soft">Status unavailable</span>
                                        {% else %}
                                            <span class="badge-soft danger">Out of range</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge-soft">No limits set</span>
                                    {% endif %}
                                </td>
                                <td>{{ entry.item.observation|default:entry.item.remarks|default:"—" }}</td>
                            </tr>
                            {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-12 col-xl-5">
        <div class="info-card mb-4">
            <div class="section-title"><i class="material-icons">play_for_work</i>Workflow actions</div>
            <div class="action-stack">
                {% if user.is_frontdesk or user.is_admin %}
                <a href="{% url 'core:sample_edit' sample.pk %}" class="btn btn-outline-primary"><i class="material-icons me-1">edit</i>Edit sample</a>
                {% if sample.current_status == 'RECEIVED_FRONT_DESK' %}
                <form method="post" action="{% url 'core:sample_status_update' sample.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="new_status" value="SENT_TO_LAB">
                    <button type="submit" class="btn btn-primary" onclick="return confirm('Send this sample to the lab for testing?')">
                        <i class="material-icons me-1">send</i>Send to lab
                    </button>
                </form>
                {% endif %}
                {% endif %}

                {% if user.is_lab_technician or user.is_admin %}
                    {% if sample.current_status == 'SENT_TO_LAB' or sample.current_status == 'TESTING_IN_PROGRESS' or sample.current_status == 'RESULTS_ENTERED' or user.is_admin and sample.current_status == 'REVIEW_PENDING' %}
                    <a href="{% url 'core:test_result_entry' sample.pk %}" class="btn btn-outline-secondary"><i class="material-icons me-1">edit_note</i>Enter / edit results</a>
                    {% endif %}
                    {% if sample.current_status == 'RESULTS_ENTERED' %}
                    <form method="post" action="{% url 'core:sample_status_update' sample.pk %}">
                        {% csrf_token %}
                        <input type="hidden" name="new_status" value="REVIEW_PENDING">
                        <button type="submit" class="btn btn-outline-secondary" onclick="return confirm('Send this sample for consultant review?')">
                            <i class="material-icons me-1">forward_to_inbox</i>Send for review
                        </button>
                    </form>
                    {% endif %}
                {% endif %}

                {% if sample.current_status == 'REPORT_APPROVED' or sample.current_status == 'REPORT_SENT' %}
                <a href="{% url 'core:download_sample_invoice' pk=sample.pk %}" class="btn btn-outline-secondary" target="_blank">
                    <i class="material-icons me-1">receipt_long</i>Download invoice
                </a>
                <a href="{% url 'core:download_sample_report' pk=sample.pk %}" class="btn btn-outline-secondary" target="_blank">
                    <i class="material-icons me-1">download</i>Download report
                </a>
                <a href="{% url 'core:download_sample_report' pk=sample.pk %}?layout=plain" class="btn btn-outline-secondary" target="_blank">
                    <i class="material-icons me-1">print</i>Plain report
                </a>
                {% endif %}

                {% if user.is_consultant or user.is_admin %}
                    {% if sample.current_status == 'RESULTS_ENTERED' or sample.current_status == 'REVIEW_PENDING' %}
                    <a href="{% url 'core:consultant_review' sample.pk %}" class="btn btn-outline-secondary"><i class="material-icons me-1">rate_review</i>Consultant review</a>
                    {% endif %}
                {% endif %}

                {% if user.is_admin %}
                <a href="{% url 'core:audit_trail' %}?model=Sample&object_id={{ sample.pk }}" class="btn btn-outline-secondary"><i class="material-icons me-1">history</i>View audit trail</a>
                    {% if sample.current_status != 'CANCELLED' %}
                    <form method="post" action="{% url 'core:sample_status_update' sample.pk %}">
                        {% csrf_token %}
                        <input type="hidden" name="new_status" value="CANCELLED">
                        <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Cancel this sample? This action cannot be undone.')">
                            <i class="material-icons me-1">cancel</i>Cancel sample
                        </button>
                    </form>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        {% if sample.review %}
        <div class="info-card">
            <div class="section-title"><i class="material-icons">assignment_ind</i>Consultant review</div>
            <dl class="row mb-3 small">
                <dt class="col-5 text-muted">Reviewer</dt>
                <dd class="col-7 mb-2">{{ sample.review.reviewer.first_name|default:sample.review.reviewer.username|default:"N/A" }}</dd>
                <dt class="col-5 text-muted">Review date</dt>
                <dd class="col-7 mb-2">{{ sample.review.review_date|date:"M d, Y H:i" }}</dd>
                <dt class="col-5 text-muted">Status</dt>
                <dd class="col-7 mb-0">
                    {% if sample.review.status == 'APPROVED' %}
                        <span class="badge-soft success">Approved</span>
                    {% elif sample.review.status == 'REJECTED' %}
                        <span class="badge-soft danger">Rejected</span>
                    {% else %}
                        <span class="badge-soft warning">{{ sample.review.get_status_display }}</span>
                    {% endif %}
                </dd>
            </dl>
            {% if sample.review.comments %}
            <div class="note-card mb-3">
                <h6>Reviewer comments</h6>
                <p class="mb-0 small">{{ sample.review.comments|linebreaksbr }}</p>
            </div>
            {% endif %}
            {% if sample.review.recommendations %}
            <div class="note-card">
                <h6>Recommendations</h6>
                <p class="mb-0 small">{{ sample.review.recommendations|linebreaksbr }}</p>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
