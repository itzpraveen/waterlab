{% extends 'core/base.html' %}
{% load static %}

{% block title %}Setup Test Parameters - Water Lab LIMS{% endblock %}


{% block page_header %}
<div class="page-header">
    <div class="page-heading">
        <span class="page-eyebrow">Laboratory configuration</span>
        <h1 class="page-title">Test Parameters Setup</h1>
        <p class="page-subtitle">Manage standard test parameters to keep sample analysis consistent and compliant.</p>
    </div>
    <div class="page-actions">
        <a href="{% url 'core:sample_add' %}" class="btn btn-outline-secondary">
            <i class="material-icons align-middle me-1">arrow_back</i>
            Back to sample registration
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="param-layout">
    <section class="info-card param-card">
        <div class="section-title"><i class="material-icons">checklist</i> Guided setup</div>
        <div class="row g-3 align-items-center">
            <div class="col-md-4">
                <div class="small text-muted">Step 1</div>
                <div class="fw-semibold">Create categories</div>
                <div class="text-muted small">Add or rename test groupings.</div>
            </div>
            <div class="col-md-3">
                <a href="{% url 'core:setup_test_categories' %}" class="btn btn-outline-secondary w-100">
                    <i class="material-icons align-middle me-1">category</i>Manage
                </a>
            </div>
            <div class="col-md-5 text-muted small">{{ categories|length }} categor{{ categories|length|pluralize:"y,ies" }} available</div>
        </div>
        <hr>
        <div class="row g-3 align-items-center">
            <div class="col-md-4">
                <div class="small text-muted">Step 2</div>
                <div class="fw-semibold">Add parameters</div>
                <div class="text-muted small">Use the form below or add our recommended set.</div>
            </div>
            <div class="col-md-3">
                <form method="post" class="m-0">
                    {% csrf_token %}
                    <button type="submit" name="action" value="create_standard" class="btn btn-outline-primary w-100">
                        <i class="material-icons align-middle me-1">playlist_add_check</i>
                        Add recommended
                    </button>
                </form>
            </div>
            <div class="col-md-5 text-muted small">Safe to repeatâ€”won't change your order</div>
        </div>
        <hr>
        <div class="row g-3 align-items-center">
            <div class="col-md-4">
                <div class="small text-muted">Step 3</div>
                <div class="fw-semibold">Arrange order</div>
                <div class="text-muted small">Drag rows in the table to set order.</div>
            </div>
        </div>
    </section>
    <section class="info-card param-card">
        <div class="section-title"><i class="material-icons">insights</i> Laboratory presets</div>
        {% if existing_params %}
        <p class="text-muted small mb-3">{{ existing_params.count }} parameter{{ existing_params.count|pluralize }} ready for sample registration.</p>
        <div class="chip-grid">
            {% for param in existing_params %}
            <span class="chip-pill">
                <span>{{ param.name }}</span>
                <small>{{ param.unit }}</small>
            </span>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info" role="alert">
            <div class="d-flex align-items-start gap-2">
                <i class="material-icons" aria-hidden="true">info</i>
                <div>
                    <strong>No test parameters found.</strong>
                    <div>Seed the standard set or add custom parameters to begin scheduling tests.</div>
                </div>
            </div>
        </div>
        {% endif %}
    </section>

    <section class="info-card param-card param-card--standard">
        <div class="section-title"><i class="material-icons">tune</i> Add a custom parameter</div>
        <div class="row g-3">
            <div class="col-md-4">
                <label for="filter_category" class="form-label">Filter by category</label>
                <form method="get">
                    <select id="filter_category" name="category" class="form-select" onchange="this.form.submit()">
                        <option value="">All categories</option>
                        {% for c in categories %}
                        <option value="{{ c.pk }}" {% if selected_category and selected_category.pk == c.pk %}selected{% endif %}>{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </form>
            </div>
            <div class="col-md-8 small text-muted d-flex align-items-end">Drag rows below to reorder within {% if selected_category %}{{ selected_category.name }}{% else %}each category{% endif %}.</div>
        </div>
</div>

    <section class="info-card param-card param-card--full">
    <div class="section-title"><i class="material-icons">add_circle</i> Add a custom parameter</div>
    <p class="text-muted">Capture analytes unique to your lab. Newly added parameters are immediately available for sample registration.</p>

    {% if form.non_field_errors %}
    <div class="alert alert-danger" role="alert">
        {% for error in form.non_field_errors %}
        <div>{{ error }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <form method="post" class="param-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="manual_create">
        <div class="field-grid">
            <div class="form-field">
                <label for="{{ form.name.id_for_label }}">Parameter name{% if form.name.field.required %}<span class="required">*</span>{% endif %}</label>
                {{ form.name }}
                {% if form.name.errors %}<div class="form-error">{{ form.name.errors.0 }}</div>{% endif %}
            </div>
            <div class="form-field">
                <label for="{{ form.unit.id_for_label }}">Unit{% if form.unit.field.required %}<span class="required">*</span>{% endif %}</label>
                {{ form.unit }}
                {% if form.unit.errors %}<div class="form-error">{{ form.unit.errors.0 }}</div>{% endif %}
            </div>
            <div class="form-field">
                <label for="{{ form.method.id_for_label }}">Method</label>
                {{ form.method }}
                {% if form.method.errors %}<div class="form-error">{{ form.method.errors.0 }}</div>{% endif %}
            </div>
            {# Order is controlled via drag-and-drop; hide manual field to reduce confusion #}
            <div class="form-field">
                <label for="{{ form.min_permissible_limit.id_for_label }}">Minimum limit</label>
                {{ form.min_permissible_limit }}
                {% if form.min_permissible_limit.errors %}<div class="form-error">{{ form.min_permissible_limit.errors.0 }}</div>{% endif %}
            </div>
            <div class="form-field">
                <label for="{{ form.max_permissible_limit.id_for_label }}">Maximum limit</label>
                {{ form.max_permissible_limit }}
                {% if form.max_permissible_limit.errors %}<div class="form-error">{{ form.max_permissible_limit.errors.0 }}</div>{% endif %}
            </div>
            <div class="form-field">
                <label for="{{ form.group.id_for_label }}">Group</label>
                {{ form.group }}
                {% if form.group.errors %}<div class="form-error">{{ form.group.errors.0 }}</div>{% endif %}
            </div>
            <div class="form-field">
                <label for="{{ form.discipline.id_for_label }}">Discipline</label>
                {{ form.discipline }}
                {% if form.discipline.errors %}<div class="form-error">{{ form.discipline.errors.0 }}</div>{% endif %}
            </div>
            <div class="form-field">
                <label for="{{ form.category_obj.id_for_label }}">Category</label>
                <div class="d-flex gap-2">
                    <div class="flex-grow-1">{{ form.category_obj }}</div>
                    <a class="btn btn-outline-secondary" href="{% url 'core:setup_test_categories' %}">
                        <i class="material-icons align-middle">category</i>
                        Manage
                    </a>
                </div>
                {% if form.category_obj.errors %}<div class="form-error">{{ form.category_obj.errors.0 }}</div>{% endif %}
            </div>
            <div class="form-field">
                <label for="{{ form.fssai_limit.id_for_label }}">FSSAI limit</label>
                {{ form.fssai_limit }}
                {% if form.fssai_limit.errors %}<div class="form-error">{{ form.fssai_limit.errors.0 }}</div>{% endif %}
            </div>
            <div class="form-field">
                <label for="{{ form.parent.id_for_label }}">Parent parameter</label>
                {{ form.parent }}
                <div class="help-text">Use to nest sub-parameters beneath a broader test.</div>
                {% if form.parent.errors %}<div class="form-error">{{ form.parent.errors.0 }}</div>{% endif %}
            </div>
        </div>

        <div class="param-form-actions">
            <button type="submit" class="btn btn-primary">
                <i class="material-icons align-middle me-1">save</i>
                Save parameter
            </button>
            <button type="reset" class="btn btn-outline-secondary">
                <i class="material-icons align-middle me-1">refresh</i>
                Reset form
            </button>
        </div>
    </form>
</section>

{% if existing_params %}
<section class="info-card param-table-card">
    <div class="section-title"><i class="material-icons">dataset</i> Existing test parameters</div>
    <div class="param-search">
        <div class="param-search-field">
            <i class="material-icons" aria-hidden="true">search</i>
            <input type="search" id="parameter-table-filter" class="form-control" placeholder="Quick search by name, method or unit..." autocomplete="off">
        </div>
        <span class="text-muted small">{{ parameters.count }} shown{% if selected_category %} ({{ selected_category.name }}){% endif %}</span>
    </div>
    <div class="table-responsive">
        <table class="table table-modern align-middle param-table" id="param-table">
            <thead>
                <tr>
                    <th style="width:44px;" title="Drag to reorder">â‡…</th>
                    <th>Parameter</th>
                    {# Order column removed; list order matches final PDF order #}
                    <th>Unit</th>
                    <th>Min limit</th>
                    <th>Max limit</th>
                    <th>Method</th>
                    <th>Group</th>
                    <th>Discipline</th>
                    <th>FSSAI limit</th>
                    <th>Category</th>
                    <th>Parent</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for param in parameters %}
                <tr data-id="{{ param.parameter_id }}" draggable="true" class="draggable-row" data-search="{{ param.name }} {{ param.unit|default:'' }} {{ param.method|default:'' }} {{ param.group|default:'' }} {{ param.discipline|default:'' }}">
                    <td class="text-muted" style="cursor:grab">&#x2630;</td>
                    <td class="fw-semibold">{{ param.name }}</td>
                    {# Removed explicit order; visual order + drag handle indicates position #}
                    <td>{{ param.unit }}</td>
                    <td>{{ param.min_permissible_limit|default:"-" }}</td>
                    <td>{{ param.max_permissible_limit|default:"-" }}</td>
                    <td>{{ param.method|default:"-" }}</td>
                    <td>{{ param.group|default:"-" }}</td>
                    <td>{{ param.discipline|default:"-" }}</td>
                    <td>{{ param.fssai_limit|default:"-" }}</td>
                    <td>{{ param.category_obj.name|default:param.category|default:"-" }}</td>
                    <td>{{ param.parent.name|default:"-" }}</td>
                    <td class="text-center">
                        <div class="param-table-actions">
                            <a href="{% url 'core:test_parameter_edit' pk=param.pk %}" class="btn btn-sm btn-outline-primary" title="Edit {{ param.name }}">
                                <i class="material-icons align-middle">edit</i>
                            </a>
                            <form method="post" action="{% url 'core:test_parameter_delete' pk=param.pk %}" onsubmit="return confirm('Delete {{ param.name }}? This cannot be undone.');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete {{ param.name }}">
                                    <i class="material-icons align-middle">delete</i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// Drag & drop reorder
(function() {
  const table = document.getElementById('param-table');
  if (!table) return;
  const tbody = table.querySelector('tbody');
  const rows = () => Array.from(tbody.querySelectorAll('tr.draggable-row'));
  let draggingEl = null;
  function handleDragStart(e){ draggingEl = e.currentTarget; e.dataTransfer.effectAllowed='move'; e.currentTarget.classList.add('dragging'); }
  function handleDragEnd(e){ e.currentTarget.classList.remove('dragging'); draggingEl=null; persistOrder(); }
  function handleDragOver(e){ e.preventDefault(); const t=e.target.closest('tr.draggable-row'); if(!t||t===draggingEl) return; const r=t.getBoundingClientRect(); const next=(e.clientY-r.top)/(r.bottom-r.top)>0.5; tbody.insertBefore(draggingEl,next?t.nextSibling:t); }
  rows().forEach(r=>{ r.addEventListener('dragstart',handleDragStart); r.addEventListener('dragend',handleDragEnd); r.addEventListener('dragover',handleDragOver); });
  function getCsrfToken(){ const el=document.querySelector('input[name="csrfmiddlewaretoken"]'); return el?el.value:''; }
  async function persistOrder(){
    const order = rows().map(r=>r.getAttribute('data-id'));
    const sel=document.querySelector('#filter_category');
    if(!sel || !sel.value){
      alert('Select a category first, then drag to reorder within it.');
      return;
    }
    const body = {order, category: sel.value};
    try{
      const res=await fetch('{% url "core:test_parameter_reorder" %}',{
        method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':getCsrfToken()},body:JSON.stringify(body)});
      if(!res.ok) throw new Error('save failed');
    }catch(err){ console.error(err); /* non-fatal */ }
  }
})();

// Quick filter
document.addEventListener('DOMContentLoaded', function() {
    const filterInput = document.getElementById('parameter-table-filter');
    const rows = Array.from(document.querySelectorAll('.param-table tbody tr'));

    if (filterInput && rows.length) {
        filterInput.addEventListener('input', event => {
            const query = event.target.value.trim().toLowerCase();
            rows.forEach(row => {
                const haystack = (row.dataset.search || '').toLowerCase();
                const isVisible = !query || haystack.includes(query);
                row.classList.toggle('param-row-hidden', !isVisible);
            });
        });
    }
});
</script>
{% endblock extra_js %}
