{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ page_title|default:"Test Results" }} - WaterLab LIMS{% endblock %}

{% block page_header %}
<div class="page-header">
    <div class="page-heading">
        <h1 class="page-title">
            <i class="material-icons align-middle me-2">science</i>
            {{ page_title|default:"Samples with Test Results" }}
        </h1>
        <p class="page-subtitle">Browse completed samples and review their recorded laboratory measurements.</p>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="results-shell">
    <form method="get" class="results-filters" role="search">
        <div class="filters-grid">
            <div class="filter-item">
                <label for="filter-search" class="form-label">Search samples</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="material-icons" aria-hidden="true">search</i></span>
                    <input id="filter-search" type="search" name="q" class="form-control" placeholder="Sample ID or customer" value="{{ search_query }}" autocomplete="off">
                </div>
            </div>
            <div class="filter-item">
                <label for="filter-status" class="form-label">Status</label>
                <select id="filter-status" name="status" class="form-select">
                    <option value="">All statuses</option>
                    <option value="PENDING" {% if status_filter|upper == 'PENDING' %}selected{% endif %}>Pending intake</option>
                    <option value="IN_LAB" {% if status_filter|upper == 'IN_LAB' %}selected{% endif %}>In laboratory</option>
                    <option value="AWAITING_REVIEW" {% if status_filter|upper == 'AWAITING_REVIEW' %}selected{% endif %}>Awaiting review</option>
                    <option value="COMPLETED" {% if status_filter|upper == 'COMPLETED' %}selected{% endif %}>Completed</option>
                    {% for code,label in sample_status_choices %}
                    <option value="{{ code }}" {% if status_filter == code %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-item">
                <label for="filter-collected" class="form-label">Collection window</label>
                <select id="filter-collected" name="collected" class="form-select">
                    <option value="">Any time</option>
                    <option value="today" {% if collected_filter == 'today' %}selected{% endif %}>Collected today</option>
                    <option value="week" {% if collected_filter == 'week' %}selected{% endif %}>Past 7 days</option>
                    <option value="month" {% if collected_filter == 'month' %}selected{% endif %}>Past 30 days</option>
                </select>
            </div>
            <div class="filter-actions">
                <button type="submit" class="btn btn-primary"><i class="material-icons me-1 align-middle">filter_alt</i>Apply</button>
                {% if show_reset_filters %}
                <a href="{% url 'core:test_result_list' %}" class="btn btn-outline-secondary"><i class="material-icons me-1 align-middle">close</i>Reset</a>
                {% endif %}
            </div>
        </div>
    </form>

    {% if search_query or status_filter or collected_filter %}
    <div class="active-filters" aria-live="polite">
        <i class="material-icons" aria-hidden="true">tune</i>
        <span>Filtered results</span>
        <ul class="active-filters__list">
            {% if search_query %}<li><span class="badge rounded-pill bg-primary">Search: {{ search_query }}</span></li>{% endif %}
            {% if status_filter %}<li><span class="badge rounded-pill bg-info text-dark">Status: {{ status_filter_label }}</span></li>{% endif %}
            {% if collected_filter %}<li><span class="badge rounded-pill bg-secondary">Collected: {{ collected_filter_label }}</span></li>{% endif %}
        </ul>
    </div>
    {% endif %}

    {% if samples_with_results %}
        {% for sample in samples_with_results %}
        <article class="results-card">
            <header class="results-card__header">
                <div>
                    <div class="results-card__headline">
                        <span class="results-card__id">{{ sample.display_id }}</span>
                        {% with status=sample.current_status %}
                        <span class="badge-soft {% if status == 'REPORT_APPROVED' or status == 'REPORT_SENT' %}success{% elif status == 'RESULTS_ENTERED' or status == 'REVIEW_PENDING' %}warning{% elif status == 'TESTING_IN_PROGRESS' %}info{% else %}info{% endif %}">
                            {{ sample.get_current_status_display }}
                        </span>
                        {% endwith %}
                    </div>
                    <ul class="results-card__meta">
                        <li><i class="material-icons" aria-hidden="true">person</i>{{ sample.customer.name }}</li>
                        <li><i class="material-icons" aria-hidden="true">event</i>{{ sample.collection_datetime|date:"M d, Y H:i" }}</li>
                        {% if sample.test_completed_on %}
                        <li><i class="material-icons" aria-hidden="true">done_all</i>{{ sample.test_completed_on|date:"M d, Y" }}</li>
                        {% endif %}
                        <li><i class="material-icons" aria-hidden="true">biotech</i>{{ sample.results.count }} result{{ sample.results.count|pluralize }}</li>
                    </ul>
                </div>
                <a href="{% url 'core:sample_detail' pk=sample.pk %}" class="btn btn-outline-primary btn-sm">View sample</a>
            </header>

            {% regroup sample.results.all by parameter.category as results_by_category %}
            {% for category in results_by_category %}
            <section class="results-block" aria-label="{{ category.grouper|default:'General Parameters' }}">
                <div class="results-block__header">
                    <h3 class="results-block__title">{{ category.grouper|default:"General Parameters" }}</h3>
                    <span class="results-block__count">{{ category.list|length }} parameter{{ category.list|length|pluralize }}</span>
                </div>
                <div class="table-responsive results-table-wrapper">
                    <table class="table table-modern align-middle results-table">
                        <thead>
                            <tr>
                                <th scope="col" class="text-center">#</th>
                                <th scope="col">Test parameter</th>
                                <th scope="col" class="d-none d-lg-table-cell">Method</th>
                                <th scope="col" class="text-center">Result</th>
                                <th scope="col">Unit</th>
                                <th scope="col">Acceptable range</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in category.list %}
                            <tr>
                                <td class="text-center text-muted">{{ forloop.counter }}</td>
                                <td>
                                    <div class="results-param">
                                        <span class="results-param__name">{{ result.parameter.name }}</span>
                                        {% if result.parameter.method %}
                                        <span class="results-param__method d-lg-none">{{ result.parameter.method }}</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="text-muted d-none d-lg-table-cell">{{ result.parameter.method|default:"--" }}</td>
                                <td class="text-center fw-semibold">{{ result.result_value }}</td>
                                <td>{{ result.parameter.unit|default:"--" }}</td>
                                <td>
                                    {% if result.parameter.max_limit_display %}
                                        <span class="results-range">{{ result.parameter.max_limit_display }}</span>
                                    {% elif result.parameter.min_permissible_limit and result.parameter.max_permissible_limit %}
                                        <span class="results-range">{{ result.parameter.min_permissible_limit }} – {{ result.parameter.max_permissible_limit }}</span>
                                    {% elif result.parameter.max_permissible_limit %}
                                        <span class="results-range">Max {{ result.parameter.max_permissible_limit }}</span>
                                    {% elif result.parameter.min_permissible_limit %}
                                        <span class="results-range">Min {{ result.parameter.min_permissible_limit }}</span>
                                    {% else %}
                                        <span class="text-muted">Not specified</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
            {% empty %}
            <p class="text-muted mb-0">No test results available for this sample.</p>
            {% endfor %}
        </article>
        {% endfor %}

        {% if is_paginated %}
        <nav aria-label="Results pagination" class="results-pagination">
            <ul class="pagination pagination-modern justify-content-center">
                <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                    <a class="page-link" href="{% if page_obj.has_previous %}?page={{ page_obj.previous_page_number }}{% else %}#!{% endif %}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>
                    {% elif num == 1 or num == page_obj.paginator.num_pages or num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
                        <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                    {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
                        <li class="page-item disabled"><span class="page-link">…</span></li>
                    {% endif %}
                {% endfor %}
                <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{% if page_obj.has_next %}?page={{ page_obj.next_page_number }}{% else %}#!{% endif %}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
        {% endif %}
    {% else %}
        <div class="alert alert-info d-flex align-items-center gap-2" role="status">
            <i class="material-icons">info_outline</i>
            <span>No test results found.</span>
        </div>
    {% endif %}
</div>
{% endblock %}
