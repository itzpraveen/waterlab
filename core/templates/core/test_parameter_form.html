{% extends 'core/base.html' %}

{% block title %}{{ page_title|default:"Manage Test Parameter" }} - WaterLab LIMS{% endblock %}

{% block page_header %}
<div class="page-header">
    <div class="page-heading">
        <span class="page-eyebrow">Test library</span>
        <h1 class="page-title">{{ page_title|default:"Manage Test Parameter" }}</h1>
        <p class="page-subtitle">Update the configuration for this laboratory test parameter.</p>
    </div>
    <div class="page-actions">
        <a href="{% url 'core:setup_test_parameters' %}" class="btn btn-outline-secondary">
            <i class="material-icons align-middle me-1">arrow_back</i>
            Back to parameters
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="parameter-form-shell">
    <section class="info-card">
        <div class="section-title"><i class="material-icons">edit_attributes</i>{{ page_title|default:"Manage Test Parameter" }}</div>
        <form method="post" class="parameter-form">
            {% csrf_token %}
            <div class="grid-two">
                <div class="form-field">
                    <label for="{{ form.name.id_for_label }}">Name<span class="required">*</span></label>
                    {{ form.name }}
                    {% if form.name.help_text %}<small class="form-hint">{{ form.name.help_text }}</small>{% endif %}
                    {% if form.name.errors %}<p class="form-error">{{ form.name.errors.0 }}</p>{% endif %}
                </div>
                <div class="form-field">
                    <label for="{{ form.unit.id_for_label }}">Unit<span class="required">*</span></label>
                    {{ form.unit }}
                    {% if form.unit.errors %}<p class="form-error">{{ form.unit.errors.0 }}</p>{% endif %}
                </div>
            </div>

            <div class="grid-two">
                <div class="form-field">
                    <label for="{{ form.price.id_for_label }}">Unit price</label>
                    {{ form.price }}
                    {% if form.price.errors %}<p class="form-error">{{ form.price.errors.0 }}</p>{% endif %}
                </div>
                <div class="form-field">
                    <label for="{{ form.method.id_for_label }}">Method</label>
                    {{ form.method }}
                    {% if form.method.errors %}<p class="form-error">{{ form.method.errors.0 }}</p>{% endif %}
                </div>
            </div>

            <div class="grid-two">
                <div class="form-field">
                    <label for="{{ form.group.id_for_label }}">Group</label>
                    {{ form.group }}
                    {% if form.group.errors %}<p class="form-error">{{ form.group.errors.0 }}</p>{% endif %}
                </div>
                <div class="form-field">
                    <label for="{{ form.discipline.id_for_label }}">Discipline</label>
                    {{ form.discipline }}
                    {% if form.discipline.errors %}<p class="form-error">{{ form.discipline.errors.0 }}</p>{% endif %}
                </div>
            </div>

            <div class="grid-two">
                <div class="form-field">
                    <label for="{{ form.min_permissible_limit.id_for_label }}">Min. permissible limit</label>
                    {{ form.min_permissible_limit }}
                    {% if form.min_permissible_limit.help_text %}<small class="form-hint">{{ form.min_permissible_limit.help_text }}</small>{% endif %}
                    {% if form.min_permissible_limit.errors %}<p class="form-error">{{ form.min_permissible_limit.errors.0 }}</p>{% endif %}
                </div>
                <div class="form-field">
                    <label for="{{ form.max_permissible_limit.id_for_label }}">Max. permissible limit</label>
                    {{ form.max_permissible_limit }}
                    {% if form.max_permissible_limit.help_text %}<small class="form-hint">{{ form.max_permissible_limit.help_text }}</small>{% endif %}
                    {% if form.max_permissible_limit.errors %}<p class="form-error">{{ form.max_permissible_limit.errors.0 }}</p>{% endif %}
                </div>
            </div>

            <div class="form-field">
                <label for="{{ form.max_limit_display.id_for_label }}">Max. limit text override</label>
                {{ form.max_limit_display }}
                {% if form.max_limit_display.help_text %}<small class="form-hint">{{ form.max_limit_display.help_text }}</small>{% endif %}
                {% if form.max_limit_display.errors %}<p class="form-error">{{ form.max_limit_display.errors.0 }}</p>{% endif %}
            </div>

            <div class="form-field">
                <label for="{{ form.fssai_limit.id_for_label }}">FSSAI limit</label>
                {{ form.fssai_limit }}
                {% if form.fssai_limit.errors %}<p class="form-error">{{ form.fssai_limit.errors.0 }}</p>{% endif %}
            </div>

            <div class="grid-two">
                <div class="form-field">
                    <label for="{{ form.category_obj.id_for_label }}">Category</label>
                    <div class="grid-two align-items-end">
                        <div>{{ form.category_obj }}</div>
                        <div class="text-end">
                            <a href="{% url 'core:setup_test_categories' %}" class="btn btn-outline-secondary btn-sm">
                                <i class="material-icons align-middle me-1">category</i>Manage categories
                            </a>
                        </div>
                    </div>
                    {% if form.category_obj.errors %}<p class="form-error">{{ form.category_obj.errors.0 }}</p>{% endif %}
                </div>
                <div class="form-field">
                    <label for="{{ form.display_order.id_for_label }}">Display order</label>
                    {{ form.display_order }}
                    <small class="form-hint">Lower numbers appear first in entry forms, reports, and PDFs.</small>
                    {% if form.display_order.errors %}<p class="form-error">{{ form.display_order.errors.0 }}</p>{% endif %}
                </div>
            </div>

            <div class="form-field">
                <label for="{{ form.parent.id_for_label }}">Parent parameter</label>
                {{ form.parent }}
                {% if form.parent.errors %}<p class="form-error">{{ form.parent.errors.0 }}</p>{% endif %}
            </div>

            {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
                {% for error in form.non_field_errors %}
                    <div>{{ error }}</div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="form-actions">
                <a href="{% url 'core:setup_test_parameters' %}" class="btn btn-light">Cancel</a>
                <button type="submit" class="btn btn-primary">
                    <i class="material-icons align-middle me-1">save</i>
                    {% if is_edit %}Save changes{% else %}Create parameter{% endif %}
                </button>
            </div>
            <datalist id="max-limit-presets">
                <option value="Absent/ml">
                <option value="Absent/100mL">
                <option value="Absent/250mL">
            </datalist>
        </form>
    </section>

    <section class="info-card muted">
        <div class="section-title"><i class="material-icons">info_outline</i>Parameter tips</div>
        <ul class="guideline-list">
            <li>Use the official BIS or IS method references where available.</li>
            <li>Leave min/max limits blank if the parameter is qualitative.</li>
            <li>Group and discipline help organise the report layout.</li>
            <li>Assign a parent parameter only when this entry is a sub-measure.</li>
        </ul>
    </section>
</div>
{% endblock %}

{% block extra_js %}{% endblock extra_js %}
